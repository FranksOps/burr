# burr — Web Scraper & Bot Defense Tester
# Deploy to: ~/burr/AGENTS.md

## Project Overview

`burr` is a Go-based web scraper and bot defense auditing tool for testing protections
on your own web properties. It probes, tests, and documents the effectiveness of
anti-bot measures including rate limiting, fingerprinting, challenge pages, and
bot detection services.

---

## Project Goals

1. **Scrape efficiently** — fetch structured data from target URLs with configurable depth
2. **Test bot defenses** — verify your own protections work as intended
3. **Bypass mitigations** — enumerate techniques that circumvent common defenses (for audit)
4. **Store results** — pluggable storage backends for scraped data
5. **Report** — generate structured reports of what defenses were defeated and how

---

## Architecture

```
cmd/
  burr/           # main binary — CLI entrypoint
internal/
  scraper/        # core fetch engine
  bypass/         # bypass technique implementations
  storage/        # storage backend interface + implementations
  report/         # structured audit report generation
  fingerprint/    # TLS/HTTP fingerprint management
pkg/
  httpclient/     # hardened http.Client with rotation, backoff
  useragent/      # UA pool management
  proxy/          # proxy rotation
```

---

## Storage Backends (implement all, select via --store flag)

| Backend | Flag | Notes |
|---|---|---|
| SQLite | `--store sqlite` | Default, zero-dependency, file-based |
| PostgreSQL | `--store postgres` | Via `pgx/v5`, DSN from env `BURR_PG_DSN` |
| JSON files | `--store json` | One file per domain, NDJSON format |
| CSV | `--store csv` | Flat, human-readable |

All backends implement the `storage.Backend` interface:
```go
type Backend interface {
    Save(ctx context.Context, result *ScrapeResult) error
    Query(ctx context.Context, filter Filter) ([]*ScrapeResult, error)
    Close() error
}
```

---

## Bypass Techniques to Implement

### HTTP Layer
- **User-agent rotation** — pool of realistic UAs (Chrome, Firefox, Safari, curl)
- **Header fingerprint spoofing** — match real browser header order and values
- **TLS fingerprint rotation** — use `utls` (github.com/refraction-networking/utls) to
  mimic Chrome/Firefox JA3/JA4 fingerprints instead of Go's default TLS client hello
- **HTTP/2 fingerprinting** — match real browser AKAMAI fingerprints
- **Referer chain simulation** — build realistic referrer chains

### Rate & Timing
- **Configurable request rate** — `--rps float` requests per second
- **Jitter** — randomized delays between requests (uniform, gaussian, pareto)
- **Burst detection avoidance** — detect and back off when 429/503 received
- **Exponential backoff with jitter** on retry

### Session & State
- **Cookie jar persistence** — maintain session state across requests
- **JavaScript challenge detection** — detect Cloudflare, Akamai, DataDome, PerimeterX
  challenge pages and log them (solve attempts are out of scope for HTTP-only mode)
- **Headless browser mode** — optional Playwright/chromedp integration for JS challenges

### IP Management
- **Proxy rotation** — HTTP/HTTPS/SOCKS5, round-robin or random, from file or env
- **Direct egress** — measure baseline detection rate without proxy

### Structural
- **Robots.txt audit mode** — fetch and report what's disallowed vs what's accessible
- **Sitemap-driven crawl** — use sitemap.xml as seed list
- **Link extraction** — BFS/DFS crawl with configurable depth and domain scope

---

## CLI Interface

```
burr [flags] <url> [url...]

Flags:
  --store string         Storage backend: sqlite|postgres|json|csv (default: sqlite)
  --db string            DB path or DSN (default: ./burr.db)
  --depth int            Crawl depth (default: 1, 0=single page)
  --rps float            Requests per second (default: 1.0)
  --jitter float         Jitter factor 0.0-1.0 (default: 0.3)
  --ua string            User agent or "rotate" (default: rotate)
  --proxy string         Proxy URL or path to proxy list file
  --tls-fingerprint string  TLS profile: go|chrome|firefox|random (default: chrome)
  --headless             Enable headless browser for JS challenge solving
  --robots               Respect robots.txt (default: false in audit mode)
  --report string        Output report: text|json|html (default: text)
  --timeout duration     Per-request timeout (default: 30s)
  --concurrency int      Parallel workers (default: 3)
  --seed string          Seed file: newline-separated URLs
  --verbose              Log all requests/responses
```

---

## Key Dependencies

```go
// go.mod additions
github.com/spf13/cobra            // CLI
github.com/spf13/viper            // Config
github.com/jackc/pgx/v5           // PostgreSQL
modernc.org/sqlite                // SQLite (pure Go, CGO-free)
github.com/refraction-networking/utls  // TLS fingerprint spoofing
github.com/PuerkitoBio/goquery    // HTML parsing (jQuery-like)
golang.org/x/net/html             // HTML tokenizer (stdlib-adjacent)
golang.org/x/sync                 // errgroup
github.com/playwright-community/playwright-go  // headless (optional build tag)
github.com/prometheus/client_golang  // metrics endpoint
```

---

## Build Tags

```go
//go:build headless    // include Playwright support
//go:build noutls      // skip utls, use stdlib TLS
```

Default build: `CGO_ENABLED=0 go build ./cmd/burr` (no headless, utls included)

---

## Ralph Loop TODO Structure

The agent should maintain `TODO.md` in this project root:

```markdown
## burr TODO

### In Progress
- [ ] (task being worked on)

### Pending
- [ ] Implement storage.Backend interface
- [ ] SQLite backend
- [ ] Postgres backend
- [ ] JSON/CSV backends
- [ ] httpclient with UA rotation
- [ ] TLS fingerprint via utls
- [ ] Rate limiter + jitter
- [ ] Cookie jar persistence
- [ ] robots.txt fetcher/parser
- [ ] BFS crawler with depth limit
- [ ] Cobra CLI wiring
- [ ] Report generator (text/json/html)
- [ ] Proxy rotation
- [ ] Integration tests

### Done
```

---

## Testing Strategy

- Unit test each storage backend with `testing.T` + in-memory or temp file
- Use `httptest.NewServer` to simulate target servers with configurable defenses
- Integration test tag: `//go:build integration`
- `go test -race ./...` must pass at every loop iteration

---

## Environment Variables

```bash
BURR_PG_DSN=postgres://user:pass@localhost/burr
BURR_PROXY_LIST=/etc/burr/proxies.txt
BURR_LOG_LEVEL=debug    # debug|info|warn|error
```

---

## Notes for Pi Agent (Ralph Loop)

- On each iteration: read `TODO.md`, pick the **first unchecked pending task**, implement it
- Run `go build ./... && go test -race ./...` after every change
- If a task requires >1 iteration, split it and document the split in `TODO.md`
- When `TODO.md` pending list is empty: output `<promise>COMPLETE</promise>`
- Commit message format: `feat(burr): <what you did in one line>`

